name: Sync upstream release

on: workflow_dispatch

env: 
  UPSTREAM: coder/code-server

jobs: 
  check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.upstream.outputs.release }}
      update: ${{ steps.check_tag.outputs.update }}
    steps:
    - name: Get Latest Upstream Release
      id: upstream
      uses: pozetroninc/github-action-get-latest-release@v0.8.0
      with: 
        #repository: ${UPSTREAM}
        owner: coder
        repo: code-server
        excludes: prerelease, draft
        token: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/checkout@v4
      id: checkout
      with:
        ref: develop
        fetch-depth: 0
    - name: Check for Tag
      id: check_tag
      run: |
          if git show-ref --tags --verify --quiet "refs/tags/${{ steps.upstream.outputs.release}}"; then
            echo "Tag ${{ steps.upstream.outputs.release }} exists"
            echo "update=false" >> $GITHUB_OUTPUT
          else
            echo "update=true" >> $GITHUB_OUTPUT
          fi
  update:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.update == true
    steps: 
    - name: Strip v prefix
      id: stripv
      run: echo "::set-output name=version::${{ steps.upstream.outputs.release }}"
    - name: Update versions
      id: replace-build
      run: sed -i '/^ARG CODESERVER_VERSION=/s/.*/ARG CODESERVER=${{ steps.stripv.outputs.version }}/' Dockerfile
    - name: Configurer les informations d'identification de Git
      run: |
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
    - name: Commuter les fichiers modifi√©s
      run: |
        git add .
        git commit -m "Bump code server version ${{ steps.stripv.outputs.version }}"
        git push


    


